<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat {{ chat.id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
</head>
<body>
<div id="chat-log" style="width: 100vw">
    {% for message in messages %}
        <div class='message-div' id="message_{{ message.id }}">
            <span>{{ message.sender.username }}</span>
            <span>{{ message.text }}</span>
            <button onclick="deleteMessage({{ message.id }})">Delete message</button>
            <button onclick="editMessageOnClick({{ message.id }})">Edit message</button>
        </div>
    {% endfor %}
</div>
<br>
<div id="chat-input">
    <input id="chat-message-input" type="text" size="100">
</div>
<br>
<button type="button" onclick="submitButtonOnClick()" id="submit-button" onkeyup="onKeyUp(e)">Send</button>
{{ chat.id|json_script:"chat-id" }}
{{ chat_type|json_script:"chat-type" }}
<script>
    const chatType = JSON.parse(document.getElementById('chat-type').textContent);
    const roomID = JSON.parse(document.getElementById('chat-id').textContent);
    const chatLog = document.querySelector('#chat-log');
    const messageInput = document.querySelector('#chat-message-input');
    const submitButton = document.querySelector('#submit-button');
    const chatInputDiv = document.querySelector('#chat-input');

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + chatType
        + '/'
        + roomID
        + '/'
    );

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log(data);
        switch (data.method) {
            case 'add_message':
                const div = document.createElement('div');
                div.className = 'message-div';
                div.textContent = `${data.message.sender} - ${data.message.text}`;
                div.id = `message_${data.message.id}`;
                const btn = document.createElement('button');
                btn.onclick = () => deleteMessage(data.message.id);
                btn.textContent = 'Delete message';
                div.append(btn);
                chatLog.append(div);
                console.log('method work');
                break;
            case 'delete_message':
                const messageDiv = document.getElementById(`message_${data.message_id}`);
                messageDiv.remove();
                break;
            case 'edit_message':
                const messageSpan = document.getElementById(`message_${data.message_id}`).querySelector('span:nth-child(2)');
                messageSpan.textContent = data.text;
                break;
            default:
                console.log('Method is not provided');
        }
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    messageInput.focus();
    const onKeyUp = (e) => {
        if (e.key === 'Enter') {
            submitButton.click();
        }
    };

    submitButtonOnClick = (e) => {
        if (messageInput.value.trim().length === 0) {
            alert("Message cannot be blank");
            messageInput.focus();
        }

        const editedMessageId = submitButton.getAttribute('edit-message-id');

        if (editedMessageId) {
            chatSocket.send(JSON.stringify({
                'method': 'edit_message',
                'message_id': editedMessageId,
                'text': messageInput.value,
            }))
            submitButton.removeAttribute('edit-message-id');
            submitButton.textContent = 'Send';
        } else {
            chatSocket.send(JSON.stringify({
                'method': 'add_message',
                'text': messageInput.value,
            }));
        }
        ;

        messageInput.value = '';
        messageInput.focus();
    };

    const deleteMessage = (messageId) => {
        chatSocket.send(JSON.stringify({
            'method': 'delete_message',
            'message_id': messageId,
        }))
    };

    const editMessageOnClick = (messageId) => {
        console.log('editMessageOnClick');
        const label = document.createElement('label');
        label.for = 'chat-message-input';
        label.id = 'label-for-chat-message-input';
        label.textContent = 'Редактирование';
        chatInputDiv.append(label);
        messageInput.value = document.getElementById(`message_${messageId}`).querySelector('span:nth-child(2)').textContent;
        messageInput.focus();
        submitButton.setAttribute('edit-message-id', messageId);
        submitButton.textContent = 'Edit';
    };

</script>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous">
</script>
</body>
</html>